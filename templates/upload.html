{% extends "index.html" %}

{% block title %}
    Upload
{% endblock %}

{% block content %}
    <form method="POST" action="/upload" class="form" enctype="multipart/form-data">
        <h2>Upload PDF</h2>

        <label for="file">Browse PDF:</label>
        <input type="file" id="file" name="file" accept="application/pdf" required>
        <br/><br/>
        <button type="submit">Upload</button>

        <label for="pdf_file">Select PDF:</label>
        <select id="pdf_file" name="pdf_file">
            <option value="" disabled selected>Select an existing PDF file</option>
            {% for pdf in pdf_files %}
                <option value="{{ pdf }}" {% if pdf == selected_pdf %}selected{% endif %}>
                    {{ pdf }}
                </option>
            {% endfor %}
        </select>
        <br/><br/>
        
        <button type="button" id="generate_ocr_btn" onclick="generateOCR()">Generate OCR</button>
        <br/><br/>
        
        <button type="button" id="convert_iast_btn" onclick="convertToIAST()">Convert to IAST</button>
        <br/><br/>
        
        <button type="button" id="post_ocr_btn" onclick="postOCR()">Post-OCR</button>
        <br/><br/>
        
        <!-- Progress Section -->
        <div id="progress_section">
            <div id="progress_bar_container">
                <div id="progress_bar"></div>
            </div>
            <div id="process_label"></div>
            <div id="log_window"></div>
        </div>
    </form>

    <script>
    function generateOCR() {
        const selectedPdf = document.getElementById('pdf_file').value;
        if (!selectedPdf) {
            alert('Please select a PDF file first.');
            return;
        }
        
        // Show progress section
        document.getElementById('progress_section').style.display = 'block';
        document.getElementById('generate_ocr_btn').disabled = true;
        
        // Reset progress
        clearLogs();
        
        // Start OCR process
        fetch('/ocr/' + encodeURIComponent(selectedPdf), {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'started' && data.job_id) {
                startProgressPolling(data.job_id, 'generate_ocr_btn');
            } else {
                document.getElementById('generate_ocr_btn').disabled = false;
            }
        })
        .catch(error => {
            document.getElementById('generate_ocr_btn').disabled = false;
        });
    }
    
    function startProgressPolling(jobId, buttonId) {
        const pollInterval = setInterval(() => {
            fetch('/ocr_progress/' + encodeURIComponent(jobId))
            .then(response => response.json())
            .then(data => {
                if (data.percent !== undefined) {
                    updateProgress(data.percent, data.process);
                }
    
                // Update logs
                if (data.logs && data.logs.length > 0) {
                    const logWindow = document.getElementById('log_window');
                    const isScrolledToBottom = logWindow.scrollHeight - logWindow.clientHeight <= logWindow.scrollTop + 1;

                    clearLogs();
                    data.logs.forEach(log => addLog(log));

                    if (isScrolledToBottom) {
                        logWindow.scrollTop = logWindow.scrollHeight;
                    }
                }
    
                // Check if processing is complete
                if (data.status === 'done') {
                    clearInterval(pollInterval);
                    document.getElementById(buttonId).disabled = false;
                }
            })
            .catch(error => {
                console.error('Error polling progress:', error);
                clearInterval(pollInterval);
                document.getElementById(buttonId).disabled = false;
            });
        }, 1000); // Poll every second
    }
    
    function convertToIAST() {
        const selectedPdf = document.getElementById('pdf_file').value;
        if (!selectedPdf) {
            alert('Please select a PDF file first.');
            return;
        }
        
        // Show progress section
        document.getElementById('progress_section').style.display = 'block';
        document.getElementById('convert_iast_btn').disabled = true;
        
        // Reset progress
        clearLogs();
        
        // Start IAST conversion process
        fetch('/iast/' + encodeURIComponent(selectedPdf), {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'started' && data.job_id) {
                startProgressPolling(data.job_id, 'convert_iast_btn');
            } else {
                document.getElementById('convert_iast_btn').disabled = false;
            }
        })
        .catch(error => {
            document.getElementById('convert_iast_btn').disabled = false;
        });
    }
    
    function postOCR() {
        const selectedPdf = document.getElementById('pdf_file').value;
        if (!selectedPdf) {
            alert('Please select a PDF file first.');
            return;
        }
        
        alert('Post-OCR functionality will be implemented later');
    }
    
    function updateProgress(percent, process = '') {
        document.getElementById('progress_bar').style.width = percent + '%';
        if (process) {
            document.getElementById('process_label').textContent = process;
        }
    }
    
    function addLog(message) {
        const logWindow = document.getElementById('log_window');
        const logEntry = document.createElement('div');
        logEntry.textContent = message;
        logWindow.appendChild(logEntry);
    }
    
    function clearLogs() {
        document.getElementById('log_window').innerHTML = '';
    }
    </script>
{% endblock %}
